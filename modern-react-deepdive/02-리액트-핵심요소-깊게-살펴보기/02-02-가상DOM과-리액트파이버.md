

# 2. 가상 DOM과 리액트 파이버

## 1) DOM과 브라우저 렌더링 과정

### DOM(Document Object Model)

- 웹페이지에 대한 인터페이스로 브라우저가 웹페이지의 콘텐츠와 구조를 어떻게 보여줄지에 대한 정보

### 브라우저 렌더링 과정

1. HTML 다운
2. HTML 파싱하여 DOM 노드로 구성된 DOM 트리 구성
3. 2.에서 CSS 파일 만나면 CSS 파일 다운로드
4. CSS 파싱하여 CSS 노드로 구성된 CSSOM 트리 구성
5. DOM 노드를 순회하며 사용자 눈에 보이는 노드만 방문
6. 5.에서 제외된 눈에 보이는 노드 대상으로 CSS 스타일 정보를 찾고 적용
   1. 레이아웃 : 좌표 계산
   2. 페인팅 : 색 등 그림

## 2) 가상 DOM의 탄생 배경

- 인터랙션에 따른 DOM의 최종 결과를 간편하게 제공 : DOM의 모든 변경 사항을 추적하는 것이 아니라, 결과적으로 만들어지는 DOM 결과물만 알도록 함

### 가상 DOM

- 리액트가 관리하는 가상의 DOM
- 웹페이지가 표시해야 할 DOM을 메모리에 저장하고, 리액트가 실제 변경에 대한 준비가 완료됐을 때 실제 브라우저 DOM에 반영

> 가상 DOM의 관리가 일반적인 DOM 관리(브라우저) 보다 빠르다?는 것은 사실이 아님

## 3) 가상 DOM을 위한 아키텍처, 리액트 파이버

리액트는 React Fiber를 통해 가상 DOM과 렌더링 과정 최적화를 수행

### 리액트 파이버란?

- 리액트 파이버는 평범한 자바스크립트 객체
- 파이버 재조정자(fiber reconciler) : 가상 DOM, 실제 DOM을 비교해 변경 사항을 수집하고, 변경 정보를 가지고 있는 파이버 기준으로 화면에 렌더링 요청
- 재조정(reconciliation) : 가상 DOM과 실제 DOM을 비교하는 알고리즘

#### 리액트 파이버가 하는 일

- 작업을 작은 단위로 분할하고 쪼개어 우선순위를 매김
- 작업을 일시 중지하고 다시 시작 가능
- 이전에 하던 작업을 재사용하거나 폐기 가능

> 모두 비동기로 작동

- 과거에는 스택으로 구현되어 동기적으로 작동
- 싱글 스레드라는 특징으로 인해 동기 작업이 중단될 수 없어 작업 중간에 다른 작업을 수행할 수 없음 -> 비효율성

#### 파이버의 구현

- 파이버는 하나의 작업 단위로 구성
- 작업을 하나씩 처리하고 `finishedWork()`으로 마무리
- 작업을 커밋해 실제 브라우저 DOM에 변경 사항 처리
  - 렌더 단계 : 모든 비동기 작업 수행하며 파이버의 작업, 우선순위, 중지, 폐기 등의 작업 수행
  - 커밋 단계 : DOM에 실제 변경사항을 반영하기 위해 `commitWork()`가 실행 -> 동기식 (중단 불가)

#### 리액트와 파이버

- 리액트는 가상 DOM이 아닌 Value UI, 즉 값을 가지고 있는 UI를 관리하는 라이브러리라는 것을 강조
- 파이버의 객체 값처럼 핵심 원칙은 UI를 문자열, 숫자, 배열과 같은 값으로 관리한다는 것

### 리액트 파이버 트리

파이버 트리는 리액트 내부에서 두 개가 존재

- 현재 모습의 파이버 트리
- 작업 중인 상태를 나타내는 트리

리액트 파이버의 작업이 끝나면 작업 중인 트리(workInProgress)를 현재 트리로 바꿔버림 = 더블 버퍼링

#### 더블 버퍼링

- 보이지 않는 곳에서 다음으로 그려야 할 그림을 미리 그린 후, 완성된 새로운 그림을 현재 상태로 바꾸는 기법
- 컴퓨터 그래픽 분야의 용어
- 리액트에서는 커밋 단계에서 수행

### 파이버의 작업 순서

업데이트 발생 시

- 업데이트 요청을 받아 workInProgress 트리를 다시 빌드

> 가급적 새로운 파이버를 생성하지 않는다.

- 기존 객체를 재활용하여 내부 속성값만 초기화하거나 변경

## 4) 파이버와 가상 DOM

> 파이버

- 컴포넌트 정보를 파이버가 1:1로 소유
- 파이버는 비동기로 동작
- 실제 DOM에 반영하는 것은 동기
- 가상 DOM으로 메모리상에서 먼저 수행하고 최종적인 결과물만 실제 DOM에 적용

> 파이버와 가상 DOM은 동일한 개념이 아님

- 가상 DOM은 웹 어플리케이션에 해당
- 리액트 네이티브와 같은 환경에서도 사용가능한 파이버

## 5) 정리

가상 DOM과 리액트의 핵심

> DOM을 더욱 빠르게 그리고 반영하는 것이 아니라 바로 값으로 UI를 표현하는 것
